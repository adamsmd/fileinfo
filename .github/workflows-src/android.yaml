  android:
    needs: [bootstrap, is-act]
    runs-on: ${{ needs.is-act.outputs.result && 'ubuntu-latest' || 'macos-latest' }}
    strategy:
      fail-fast: false
      matrix:
        target: ## Choose only one of these, depending on your device...
          # - aarch64-linux-android
          # - armv7a-linux-androideabi
          - i686-linux-android
          # - x86_64-linux-android
          # TODO: other ABIs in older NDKs
        api: ## minSdkVersion
          # - 15
          # - 16
          # - 17
          # - 18
          # - 19
          # - 20
          # - 21
          # - 22
          # - 23
          # - 24
          # - 25
          # - 26
          # - 27
          # - 28
          - 29
          # - 30
          # - 31
    env:
      API: ${{ matrix.api }}
      NDK: 23.1.7779620 # TODO: auto-detect
      TARGET: ${{ matrix.target }}

      DEST_DIR: /data/local/tmp

    steps:
      ## Ensure $ANDROID_SDK_ROOT is setup as it is missing on `act`
      - run: |
          if [ -z "$ANDROID_SDK_ROOT" ]; then
            echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV
          fi
      - run: sudo mkdir -p "$ANDROID_SDK_ROOT" || true
      - run: sudo chmod a+rwx "$ANDROID_SDK_ROOT"

      - if: ${{ env.ACT }}
        run: sudo apt-get update
      - if: ${{ env.ACT }}
        run: sudo apt-get install --assume-yes default-jre

      - uses: actions/download-artifact@v2
        with: { name: bootstrap-output }
      - run: tar -xvf fileinfo.tar

      - uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ env.API }}
          ndk: ${{ env.NDK }}
          # target: TODO
          # arch: TODO
          # profile: TODO
          script: |
            .github/configure-android --host="${{ env.TARGET }}"
            cat src/config.h
            cat src/headers.h
            cat src/fileinfo/static.h
            make
            make check

            adb push fileinfo-fields-dynamic "$DEST_DIR"/
            adb shell chmod a+x "$DEST_DIR"/fileinfo-fields-dynamic
            adb shell "$DEST_DIR"/fileinfo-fields-dynamic

            adb push fileinfo-file-dynamic "$DEST_DIR"/
            adb shell chmod a+x "$DEST_DIR"/fileinfo-file-dynamic
            adb shell "$DEST_DIR"/fileinfo-file-dynamic .
